From db5c1ebeb614ea98fb325d1277ba8a7b5119823a Mon Sep 17 00:00:00 2001
From: John Clark <inindev@gmail.com>
Date: Sat, 26 Jun 2021 18:25:01 -0400
Subject: [PATCH 3/3] arm64: rk3399: set ethaddr and eth1addr from eeprom

---
 arch/arm/mach-rockchip/misc.c       | 37 ++++++++++++++++-------------
 configs/nanopi-r4s-rk3399_defconfig |  7 +++---
 2 files changed, 25 insertions(+), 19 deletions(-)

diff --git a/arch/arm/mach-rockchip/misc.c b/arch/arm/mach-rockchip/misc.c
index 87eebd9872..8d34ebdd7f 100644
--- a/arch/arm/mach-rockchip/misc.c
+++ b/arch/arm/mach-rockchip/misc.c
@@ -13,6 +13,7 @@
 #include <env.h>
 #include <dm.h>
 #include <hash.h>
+#include <i2c.h>
 #include <log.h>
 #include <dm/uclass-internal.h>
 #include <misc.h>
@@ -25,33 +26,37 @@ int rockchip_setup_macaddr(void)
 {
 #if CONFIG_IS_ENABLED(CMD_NET)
 	int ret;
-	const char *cpuid = env_get("cpuid#");
-	u8 hash[SHA256_SUM_LEN];
-	int size = sizeof(hash);
+	struct udevice *bus;
+	struct udevice *dev;
 	u8 mac_addr[6];
 
-	/* Only generate a MAC address, if none is set in the environment */
-	if (env_get("ethaddr"))
-		return 0;
-
-	if (!cpuid) {
-		debug("%s: could not retrieve 'cpuid#'\n", __func__);
+	ret = uclass_get_device_by_name(UCLASS_I2C, "i2c@ff120000", &bus);
+	if (ret) {
+		debug("%s: uclass_get_device_by_name failed: %d\n", __func__, ret);
 		return -1;
 	}
 
-	ret = hash_block("sha256", (void *)cpuid, strlen(cpuid), hash, &size);
+	ret = dm_i2c_probe(bus, 0x51, 0, &dev);
 	if (ret) {
-		debug("%s: failed to calculate SHA256\n", __func__);
+		debug("%s: dm_i2c_probe failed: %d\n", __func__, ret);
 		return -1;
 	}
 
-	/* Copy 6 bytes of the hash to base the MAC address on */
-	memcpy(mac_addr, hash, 6);
+	ret = dm_i2c_read(dev, 0xfa, mac_addr, sizeof(mac_addr));
+	if (ret) {
+		debug("%s: dm_i2c_read failed: %d\n", __func__, ret);
+		return -1;
+	}
 
-	/* Make this a valid MAC address and set it */
-	mac_addr[0] &= 0xfe;  /* clear multicast bit */
-	mac_addr[0] |= 0x02;  /* set local assignment bit (IEEE802) */
+	/* ethaddr: wan */
+	mac_addr[5] &= 0xfe;
+	debug("%s: setting ethaddr: %02x %02x %02x %02x %02x %02x\n", __func__, mac_addr[0], mac_addr[1], mac_addr[2], mac_addr[3], mac_addr[4], mac_addr[5]);
 	eth_env_set_enetaddr("ethaddr", mac_addr);
+
+	/* eth1addr: lan */
+	mac_addr[5] |= 0x01;
+	debug("%s: setting eth1addr: %02x %02x %02x %02x %02x %02x\n", __func__, mac_addr[0], mac_addr[1], mac_addr[2], mac_addr[3], mac_addr[4], mac_addr[5]);
+	eth_env_set_enetaddr("eth1addr", mac_addr);
 #endif
 	return 0;
 }
diff --git a/configs/nanopi-r4s-rk3399_defconfig b/configs/nanopi-r4s-rk3399_defconfig
index 9f0bf6ccea..da9ca1690e 100644
--- a/configs/nanopi-r4s-rk3399_defconfig
+++ b/configs/nanopi-r4s-rk3399_defconfig
@@ -1,15 +1,17 @@
 CONFIG_ARM=y
 CONFIG_ARCH_ROCKCHIP=y
 CONFIG_SYS_TEXT_BASE=0x00200000
+CONFIG_NR_DRAM_BANKS=1
 CONFIG_ENV_OFFSET=0x3F8000
 CONFIG_ROCKCHIP_RK3399=y
 CONFIG_TARGET_EVB_RK3399=y
-CONFIG_NR_DRAM_BANKS=1
 CONFIG_DEBUG_UART_BASE=0xFF1A0000
 CONFIG_DEBUG_UART_CLOCK=24000000
+CONFIG_DEFAULT_DEVICE_TREE="rk3399-nanopi-r4s"
 CONFIG_DEBUG_UART=y
-CONFIG_DEFAULT_FDT_FILE="rockchip/rk3399-nanopi-r4s.dtb"
+CONFIG_DEFAULT_FDT_FILE="rk3399-nanopi-r4s.dtb"
 CONFIG_DISPLAY_BOARDINFO_LATE=y
+CONFIG_MISC_INIT_R=y
 # CONFIG_SPL_RAW_IMAGE_SUPPORT is not set
 CONFIG_SPL_STACK_R=y
 CONFIG_SPL_STACK_R_MALLOC_SIMPLE_LEN=0x10000
@@ -21,7 +23,6 @@ CONFIG_CMD_USB=y
 # CONFIG_CMD_SETEXPR is not set
 CONFIG_CMD_TIME=y
 CONFIG_SPL_OF_CONTROL=y
-CONFIG_DEFAULT_DEVICE_TREE="rk3399-nanopi-r4s"
 CONFIG_OF_SPL_REMOVE_PROPS="pinctrl-0 pinctrl-names clock-names interrupt-parent assigned-clocks assigned-clock-rates assigned-clock-parents"
 CONFIG_ENV_IS_IN_MMC=y
 CONFIG_SYS_RELOC_GD_ENV_ADDR=y
-- 
2.20.1

